<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giornale Cassa Allianz (Firestore)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --colore-primario: #005f73; --colore-secondario: #0a9396; --colore-sfondo: #f8f9fa;
            --colore-container: #ffffff; --colore-testo: #212529; --colore-grigio: #6c757d;
            --colore-pericolo: #d90429; --colore-successo: #008000;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px; color: var(--colore-testo); background-color: var(--colore-sfondo);
        }
        .container {
            max-width: 1300px; margin: auto; background-color: var(--colore-container);
            padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        /* ... (Il resto del CSS √® identico a quello fornito) ... */
        h1 {
            text-align: center; font-size: 2.5em; padding: 15px; border-radius: 8px; color: white;
            background: linear-gradient(145deg, #495057, #212529); text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .section-title {
            color: var(--colore-primario); border-bottom: 2px solid var(--colore-secondario);
            padding-bottom: 10px; margin-top: 25px;
        }
        .controls, .backup-section, .main-actions {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            gap: 15px; padding: 15px; background: #e9ecef; border-radius: 8px; margin-bottom: 20px;
        }
        form {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;
            margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;
        }
        label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input, select { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em; }
        input:focus, select:focus { border-color: var(--colore-secondario); outline: none; box-shadow: 0 0 0 2px rgba(10, 147, 150, 0.25); }
        button, .button-like {
            padding: 10px 15px; border: none; border-radius: 5px; font-size: 1em; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover, .button-like:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; transform: none; box-shadow: none; }
        .primary-action { background-color: var(--colore-primario); color: white; }
        .secondary-action { background-color: var(--colore-grigio); color: white; }
        .danger-action { background-color: var(--colore-pericolo); color: white; }
        .success-action { background-color: var(--colore-successo); color: white; }
        .print-action { background-color: #0a9396; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #343a40; color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .total-display { margin-top: 25px; text-align: right; font-size: 1.6em; font-weight: bold; color: var(--colore-primario); }
        .print-only { display: none; }
        
        .icon-btn {
            background: none; border: none; cursor: pointer; font-size: 1.2em;
            padding: 2px 5px; margin: 0 3px; border-radius: 4px; transition: background-color 0.2s;
        }
        .icon-btn:hover { background-color: #e9ecef; }
        
        @media print {
            @page { size: A4 portrait; margin: 2cm; }
            body { font-size: 10pt; color: #000; }
            body > *:not(.print-only) { display: none !important; }
            .print-only { display: block; }
            #print-header-content h1 { font-size: 18pt; margin-bottom: 5px; text-align: center; }
            #print-header-content h2 { font-size: 14pt; font-weight: bold; text-align: center; }
            #print-header-content p { font-size: 9pt; text-align: right; }
            #print-table-content table { width: 100%; font-size: 9pt; border-collapse: collapse; table-layout: fixed; }
            #print-table-content th, #print-table-content td { border: 1px solid #666; padding: 6px; word-wrap: break-word; text-align: left; }
            #print-table-content th { background-color: #e9ecef; }
            #print-total-content { text-align: right; font-size: 12pt; font-weight: bold; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="print-only">
        <div id="print-header-content"></div>
        <div id="print-table-content"></div>
        <div id="print-total-content"></div>
    </div>

    <div class="container">
        <h1>Giornale Cassa Allianz Gino (Firestore)</h1>
        
        <div class="controls">
            <div>
                <label for="giornali-salvati"><strong>Consulta un giornale chiuso:</strong></label>
                <select id="giornali-salvati"></select>
            </div>
            <div id="closed-journal-actions">
                <button id="stampa-btn" class="print-action">üñ®Ô∏è Stampa Giornale</button>
                <button id="riapri-giornale-btn" class="secondary-action">Riapri Giornale</button>
                <button id="elimina-giornale-btn" class="danger-action">Elimina Giornale</button>
            </div>
        </div>
        
        <div id="no-open-journal-view" class="main-actions">
            <span>Nessun giornale aperto. Selezionane uno da consultare o creane uno nuovo.</span>
            <button id="crea-nuovo-btn" class="success-action">Crea Nuovo Giornale</button>
        </div>

        <div id="main-view">
            <h2 class="section-title" id="titolo-giornale"></h2>
            <form id="movimento-form">
                <div class="form-group"><label for="ramo-polizza">Ramo Polizza</label><select id="ramo-polizza" required><option value="Auto">Auto</option><option value="Rami Vari">Rami Vari</option><option value="Vita">Vita</option></select></div>
                <div class="form-group"><label for="numero-polizza">N. Polizza</label><input type="text" id="numero-polizza" required></div>
                <div class="form-group"><label for="tipo-movimento">Tipo Movimento</label><select id="tipo-movimento" required><option value="Nuova Polizza">Nuova Polizza</option><option value="Quietanza">Quietanza</option><option value="Rimborso Premio">Rimborso Premio</option><option value="Regolazione Premio">Regolazione Premio</option><option value="Franchigia">Franchigia</option><option value="Sostituzione">Sostituzione</option><option value="Storno">Storno</option></select></div>
                <div class="form-group"><label for="modalita-pagamento">Modalit√† Pagamento</label><select id="modalita-pagamento" required><option value="Contanti">Contanti</option><option value="Assegno">Assegno</option><option value="Bonifico">Bonifico</option><option value="Allianz Bank">Allianz Bank</option><option value="POS Agenzia">POS Agenzia</option><option value="POS Direzione">POS Direzione</option></select></div>
                <div class="form-group"><label for="data-incasso">Data Incasso</label><input type="date" id="data-incasso" required></div>
                <div class="form-group"><label for="nome-cliente">Nome Cliente</label><input type="text" id="nome-cliente" required></div>
                <div class="form-group"><label for="importo">Importo Titolo (‚Ç¨)</label><input type="number" id="importo" step="0.01" min="0" required></div>
                <input type="hidden" id="editing-id">
                <button type="submit" id="submit-btn" class="primary-action" style="grid-column: 1 / -1;">Aggiungi Movimento</button>
            </form>
            <div class="main-actions" id="open-journal-actions">
                <button id="chiudi-giornale-btn" class="danger-action">Chiudi Giornale Cassa</button>
            </div>
            <table>
                <thead>
                    <tr><th>Ramo</th><th>N. Polizza</th><th>Movimento</th><th>Pagamento</th><th>Data Incasso</th><th>Cliente</th><th>Importo</th><th class="no-print">Azioni</th></tr>
                </thead>
                <tbody id="tabella-movimenti"></tbody>
            </table>
            <div class="total-display">Totale Cassa (Contanti e Assegni): ‚Ç¨ <span id="totale-cassa">0.00</span></div>
        </div>

        <h2 class="section-title">Database</h2>
        <div class="backup-section" style="justify-content: center;">
            <p>I dati sono salvati automaticamente e in tempo reale su Firebase Firestore.</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. INIZIALIZZAZIONE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDqRAWYaoEQvpo9Eh0QfS351AdNuxse7kI",
          authDomain: "giornalecassagino.firebaseapp.com",
          projectId: "giornalecassagino",
          storageBucket: "giornalecassagino.firebasestorage.app",
          messagingSenderId: "792465698914",
          appId: "1:792465698914:web:57c4ae252e24abde5aa13b"
        };

        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const giornaliCollection = db.collection('giornali');
        
        // --- FINE INIZIALIZZAZIONE ---

        const app = {
            // 'data' ora funge da cache locale dei dati di Firestore
            data: { giornali: [] },
            stato: { giornaleApertoId: null, giornaleVisualizzatoId: null, idInModifica: null },
            
            // init() deve essere ASINCRONO per attendere il caricamento da Firestore
            async init() {
                try {
                    await this.loadData(); // Attende il caricamento dei dati
                    this.addEventListeners();
                    this.render();
                } catch (error) {
                    console.error("Impossibile inizializzare l'app:", error);
                    alert("ERRORE CRITICO: Impossibile caricare i dati dal database. Controlla la connessione e la configurazione di Firebase.");
                }
            },
            
            // MODIFICA: loadData() ora carica da Firestore
            async loadData() {
                console.log("Caricamento dati da Firestore...");
                const snapshot = await giornaliCollection.orderBy("id", "desc").get();
                
                this.data.giornali = snapshot.docs.map(doc => ({
                    firestoreId: doc.id, // Salviamo l'ID del documento Firestore
                    ...doc.data()
                }));

                const giornaleAperto = this.data.giornali.find(g => g.stato === 'aperto');
                if (giornaleAperto) {
                    this.stato.giornaleApertoId = giornaleAperto.id;
                    this.stato.giornaleVisualizzatoId = giornaleAperto.id;
                }
                console.log("Dati caricati.", this.data);
            },
            
            // RIMOSSA: saveData() non √® pi√π necessaria, salviamo direttamente su Firestore
            // saveData() { ... }

            render() { 
                const giornaleVisualizzato = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); 
                this.renderUI(giornaleVisualizzato); 
                this.renderDropdown(); 
                this.renderTabella(giornaleVisualizzato); 
                this.renderTotale(giornaleVisualizzato); 
            },
            
            renderUI(giornale) { 
                const mainView = document.getElementById('main-view'), 
                      noOpenJournalView = document.getElementById('no-open-journal-view'), 
                      form = document.getElementById('movimento-form'), 
                      openJournalActions = document.getElementById('open-journal-actions'), 
                      closedJournalActions = document.getElementById('closed-journal-actions'), 
                      titoloGiornale = document.getElementById('titolo-giornale'); 
                
                mainView.style.display = 'none'; 
                noOpenJournalView.style.display = 'none'; 
                form.style.display = 'none'; 
                openJournalActions.style.display = 'none'; 
                closedJournalActions.style.display = 'none'; 
                
                if (!this.stato.giornaleApertoId && !giornale) { 
                    noOpenJournalView.style.display = 'flex'; 
                } else { 
                    mainView.style.display = 'block'; 
                    if (giornale && giornale.stato === 'aperto') { 
                        titoloGiornale.textContent = 'Giornale Cassa Attuale (Aperto)'; 
                        form.style.display = 'grid'; 
                        openJournalActions.style.display = 'flex'; 
                    } else if (giornale) { 
                        titoloGiornale.textContent = `Riepilogo Giornale N. ${giornale.numero || 'N/A'}/${giornale.anno || 'N/A'} (Chiuso il ${giornale.dataChiusura})`; 
                        closedJournalActions.style.display = 'flex'; 
                    } else {
                        // Caso transitorio, ad es. dopo l'eliminazione
                         noOpenJournalView.style.display = 'flex';
                    }
                } 
            },
            
            renderDropdown() { 
                const select = document.getElementById('giornali-salvati'); 
                select.innerHTML = '<option value="">Seleziona per consultare...</option>'; 
                this.data.giornali
                    .filter(g => g.stato === 'chiuso')
                    .sort((a, b) => (b.anno - a.anno) || (b.numero - a.numero))
                    .forEach(g => { 
                        const option = document.createElement('option'); 
                        option.value = g.id; 
                        option.textContent = `N. ${g.numero || 'N/A'}/${g.anno || 'N/A'} - Chiuso il ${g.dataChiusura}`; 
                        select.appendChild(option); 
                    }); 
                // Assicura che l'ID sia una stringa per il confronto con 'select.value'
                const visualizzatoIdStr = this.stato.giornaleVisualizzatoId ? this.stato.giornaleVisualizzatoId.toString() : "";
                const apertoIdStr = this.stato.giornaleApertoId ? this.stato.giornaleApertoId.toString() : "";
                
                select.value = (visualizzatoIdStr !== apertoIdStr) ? visualizzatoIdStr : ""; 
            },
            
            renderTabella(giornale) {
                /* ... (Logica di renderTabella invariata) ... */
                const tbody = document.getElementById('tabella-movimenti');
                tbody.innerHTML = '';
                if (!giornale) return;
                giornale.movimenti.forEach(m => {
                    const row = tbody.insertRow();
                    const actionsHTML = giornale.stato === 'aperto'
                        ? `<button class="icon-btn edit-btn" title="Modifica movimento" data-id="${m.id}">‚úèÔ∏è</button>
                           <button class="icon-btn delete-btn" title="Elimina movimento" data-id="${m.id}">‚ùå</button>`
                        : '‚Äî';
                    
                    row.innerHTML = `<td>${m.ramo}</td><td>${m.numeroPolizza}</td><td>${m.tipo}</td><td>${m.pagamento}</td><td>${new Date(m.data).toLocaleDateString('it-IT')}</td><td>${m.cliente}</td><td>${m.importo.toFixed(2).replace('.',',')} ‚Ç¨</td><td class="no-print">${actionsHTML}</td>`;
                });
            },
            
            renderTotale(giornale) { 
                /* ... (Logica di renderTotale invariata) ... */
                const totaleEl = document.getElementById('totale-cassa'); 
                if (!giornale) { totaleEl.textContent = '0.00'; return; } 
                const totale = giornale.movimenti
                    .filter(m => m.pagamento === 'Contanti' || m.pagamento === 'Assegno')
                    .reduce((sum, m) => sum + m.importo, 0); 
                totaleEl.textContent = totale.toFixed(2).replace('.', ','); 
            },
            
            addEventListeners() { 
                document.getElementById('crea-nuovo-btn').addEventListener('click', () => this.creaNuovoGiornale()); 
                document.getElementById('movimento-form').addEventListener('submit', (e) => this.gestisciSubmit(e)); 
                document.getElementById('tabella-movimenti').addEventListener('click', (e) => this.gestisciClickTabella(e)); 
                document.getElementById('chiudi-giornale-btn').addEventListener('click', () => this.chiudiGiornale()); 
                document.getElementById('giornali-salvati').addEventListener('change', (e) => this.visualizzaGiornaleSalvato(e)); 
                document.getElementById('riapri-giornale-btn').addEventListener('click', () => this.riapriGiornale()); 
                document.getElementById('elimina-giornale-btn').addEventListener('click', () => this.eliminaGiornale()); 
                document.getElementById('stampa-btn').addEventListener('click', () => this.stampaGiornale()); 
                // Event listener per Backup e Ripristino rimossi
            },

            // MODIFICA: La funzione ora √® ASINCRONA e salva su Firestore
            async eliminaMovimento(movimentoId) {
                if (!confirm('Sei sicuro di voler eliminare questo movimento?')) return;
                
                const giornaleAperto = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                if (!giornaleAperto) return;
                
                // 1. Aggiorna l'array locale
                giornaleAperto.movimenti = giornaleAperto.movimenti.filter(m => m.id !== movimentoId);
                
                // 2. Salva l'array aggiornato su Firestore
                try {
                    await giornaliCollection.doc(giornaleAperto.firestoreId).update({
                        movimenti: giornaleAperto.movimenti
                    });
                    // 3. Ricarica la vista
                    this.render();
                } catch (error) {
                    console.error("Errore eliminazione movimento: ", error);
                    alert("Errore durante l'eliminazione del movimento.");
                    // Potenziale rollback (ricaricando i dati)
                    location.reload(); 
                }
            },

            gestisciClickTabella(e) {
                /* ... (Logica di gestisciClickTabella invariata) ... */
                const target = e.target.closest('.icon-btn');
                if (!target) return;

                const id = parseInt(target.dataset.id);
                if (target.classList.contains('edit-btn')) {
                    const giornaleAperto = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                    const movimento = giornaleAperto.movimenti.find(m => m.id === id);
                    document.getElementById('ramo-polizza').value = movimento.ramo; 
                    document.getElementById('numero-polizza').value = movimento.numeroPolizza; 
                    document.getElementById('tipo-movimento').value = movimento.tipo; 
                    document.getElementById('modalita-pagamento').value = movimento.pagamento; 
                    document.getElementById('data-incasso').value = movimento.data; 
                    document.getElementById('nome-cliente').value = movimento.cliente; 
                    document.getElementById('importo').value = movimento.importo;
                    this.stato.idInModifica = id;
                    document.getElementById('submit-btn').textContent = 'Salva Modifiche';
                    window.scrollTo(0, 0);
                } else if (target.classList.contains('delete-btn')) {
                    this.eliminaMovimento(id);
                }
            },
            
            stampaGiornale() { 
                /* ... (Logica di stampaGiornale invariata) ... */
                const giornale = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); 
                if (!giornale) { alert("Per favore, seleziona un giornale da stampare."); return; } 
                const headerContainer = document.getElementById('print-header-content'); 
                const oggi = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }); 
                let headerHTML = `<h1>Giornale Cassa Allianz Gino</h1>`; 
                if (giornale.stato === 'chiuso') { 
                    headerHTML += `<h2>Giornale N. ${giornale.numero || 'N/A'}/${giornale.anno || 'N/A'} - Chiuso il ${giornale.dataChiusura}</h2>`; 
                } else { 
                    headerHTML += `<h2>Giornale Attuale (Aperto - non ancora numerato)</h2>`; 
                } 
                headerHTML += `<p>Stampato il: ${oggi}</p>`; 
                headerContainer.innerHTML = headerHTML; 
                const tableContainer = document.getElementById('print-table-content'); 
                let tableHTML = `<table><thead><tr><th style="width:10%">Ramo</th><th style="width:13%">N. Polizza</th><th style="width:17%">Movimento</th><th style="width:13%">Pagamento</th><th style="width:12%">Data Incasso</th><th style="width:23%">Cliente</th><th style="width:12%">Importo</th></tr></thead><tbody>`; 
                giornale.movimenti.forEach(m => { tableHTML += `<tr><td>${m.ramo}</td><td>${m.numeroPolizza}</td><td>${m.tipo}</td><td>${m.pagamento}</td><td>${new Date(m.data).toLocaleDateString('it-IT')}</td><td>${m.cliente}</td><td>${m.importo.toFixed(2).replace('.',',')} ‚Ç¨</td></tr>`; }); 
                tableHTML += `</tbody></table>`; 
                tableContainer.innerHTML = tableHTML; 
                const totalContainer = document.getElementById('print-total-content'); 
                const totale = giornale.movimenti.filter(m => m.pagamento === 'Contanti' || m.pagamento === 'Assegno').reduce((sum, m) => sum + m.importo, 0); 
                totalContainer.innerHTML = `Totale Cassa (Contanti e Assegni): ‚Ç¨ ${totale.toFixed(2).replace('.', ',')}`; 
                window.print(); 
            },
            
            // MODIFICA: La funzione ora √® ASINCRONA e crea un documento su Firestore
            async creaNuovoGiornale() {
                if(this.stato.giornaleApertoId) { 
                    alert("Puoi creare un nuovo giornale solo dopo aver chiuso quello attuale."); 
                    return; 
                }
                
                const nuovoGiornale = { 
                    id: Date.now(), // Usiamo ancora un ID univoco locale
                    numero: null, 
                    anno: null, 
                    dataChiusura: null, 
                    stato: 'aperto', 
                    movimenti: [] 
                }; 
                
                try {
                    // 1. Salva il nuovo giornale su Firestore
                    const docRef = await giornaliCollection.add(nuovoGiornale);
                    
                    // 2. Aggiorna l'oggetto locale con l'ID di Firestore
                    nuovoGiornale.firestoreId = docRef.id;
                    
                    // 3. Aggiorna la cache locale e lo stato
                    this.data.giornali.unshift(nuovoGiornale); // Aggiungi in cima
                    this.stato.giornaleApertoId = nuovoGiornale.id; 
                    this.stato.giornaleVisualizzatoId = nuovoGiornale.id; 
                    
                    // 4. Ricarica la vista
                    this.render();
                } catch (error) {
                    console.error("Errore creazione nuovo giornale: ", error);
                    alert("Errore durante la creazione del nuovo giornale.");
                }
            },
            
            // MODIFICA: La funzione ora √® ASINCRONA e aggiorna un documento su Firestore
            async chiudiGiornale() { 
                if (!confirm('Sei sicuro di voler chiudere il giornale cassa attuale?')) return; 
                
                const giornaleDaChiudere = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                if (!giornaleDaChiudere) return;

                const annoCorrente = new Date().getFullYear().toString();
                
                const giornaliDellAnno = this.data.giornali.filter(g => g.anno === annoCorrente && g.stato === 'chiuso');
                const maxNumero = giornaliDellAnno.reduce((max, g) => Math.max(max, g.numero || 0), 0);
                
                // 1. Prepara i dati da aggiornare
                const aggiornamenti = {
                    stato: 'chiuso',
                    dataChiusura: new Date().toLocaleDateString('it-IT'),
                    numero: maxNumero + 1,
                    anno: annoCorrente
                };

                try {
                    // 2. Aggiorna il documento su Firestore
                    await giornaliCollection.doc(giornaleDaChiudere.firestoreId).update(aggiornamenti);
                    
                    // 3. Aggiorna la cache locale
                    Object.assign(giornaleDaChiudere, aggiornamenti);
                    
                    // 4. Aggiorna lo stato
                    this.stato.giornaleApertoId = null; 
                    this.stato.giornaleVisualizzatoId = giornaleDaChiudere.id; 
                    
                    // 5. Ricarica la vista
                    this.render(); 
                } catch (error) {
                    console.error("Errore chiusura giornale: ", error);
                    alert("Errore durante la chiusura del giornale.");
                }
            },

            // MODIFICA: La funzione ora √® ASINCRONA e aggiorna un documento su Firestore
            async riapriGiornale() { 
                if (this.stato.giornaleApertoId) { 
                    alert("Chiudi prima il giornale corrente per poter riaprire questo."); 
                    return; 
                } 
                const giornaleDaRiaprire = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); 
                if (!giornaleDaRiaprire || giornaleDaRiaprire.stato !== 'chiuso') { 
                    alert("Seleziona un giornale chiuso da riaprire."); 
                    return; 
                } 
                if (!confirm('Sei sicuro di voler riaprire questo giornale?')) return; 
                
                // 1. Prepara i dati da aggiornare
                const aggiornamenti = {
                    stato: 'aperto',
                    numero: null,
                    anno: null,
                    dataChiusura: null
                };

                try {
                    // 2. Aggiorna il documento su Firestore
                    await giornaliCollection.doc(giornaleDaRiaprire.firestoreId).update(aggiornamenti);
                    
                    // 3. Aggiorna la cache locale
                    Object.assign(giornaleDaRiaprire, aggiornamenti);
                    
                    // 4. Aggiorna lo stato
                    this.stato.giornaleApertoId = giornaleDaRiaprire.id; 
                    this.stato.giornaleVisualizzatoId = giornaleDaRiaprire.id; 
                    
                    // 5. Ricarica la vista
                    this.render(); 
                } catch (error) {
                    console.error("Errore riapertura giornale: ", error);
                    alert("Errore durante la riapertura del giornale.");
                }
            },
            
            // MODIFICA: La funzione ora √® ASINCRONA ed elimina un documento da Firestore
            async eliminaGiornale() { 
                const giornaleDaEliminare = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); 
                if (!giornaleDaEliminare || giornaleDaEliminare.stato !== 'chiuso') { 
                    alert("Puoi eliminare solo un giornale chiuso."); 
                    return; 
                } 
                if (!confirm(`Sei sicuro di voler eliminare definitivamente il "Giornale Cassa N. ${giornaleDaEliminare.numero || 'N/A'}/${giornaleDaEliminare.anno || 'N/A'}"? L'azione √® irreversibile.`)) return; 
                
                try {
                    // 1. Elimina il documento da Firestore
                    await giornaliCollection.doc(giornaleDaEliminare.firestoreId).delete();
                    
                    // 2. Elimina dalla cache locale
                    this.data.giornali = this.data.giornali.filter(g => g.id !== giornaleDaEliminare.id); 
                    
                    // 3. Aggiorna lo stato
                    this.stato.giornaleVisualizzatoId = null; 
                    
                    // 4. Ricarica la vista
                    this.render(); 
                } catch (error) {
                    console.error("Errore eliminazione giornale: ", error);
                    alert("Errore durante l'eliminazione del giornale.");
                }
            },
            
            visualizzaGiornaleSalvato(e) { 
                const id = parseInt(e.target.value); 
                this.stato.giornaleVisualizzatoId = id || this.stato.giornaleApertoId || null; 
                this.render(); 
            },
            
            // MODIFICA: La funzione ora √® ASINCRONA e aggiorna l'array 'movimenti' su Firestore
            async gestisciSubmit(e) { 
                e.preventDefault(); 
                const giornaleAperto = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId); 
                if (!giornaleAperto) return; 
                
                const formData = { 
                    id: this.stato.idInModifica || Date.now(), 
                    ramo: document.getElementById('ramo-polizza').value, 
                    numeroPolizza: document.getElementById('numero-polizza').value, 
                    tipo: document.getElementById('tipo-movimento').value, 
                    pagamento: document.getElementById('modalita-pagamento').value, 
                    data: document.getElementById('data-incasso').value, 
                    cliente: document.getElementById('nome-cliente').value, 
                    importo: parseFloat(document.getElementById('importo').value) 
                }; 
                
                // 1. Aggiorna l'array locale
                if (this.stato.idInModifica) { 
                    const index = giornaleAperto.movimenti.findIndex(m => m.id === this.stato.idInModifica); 
                    giornaleAperto.movimenti[index] = formData; 
                    this.stato.idInModifica = null; 
                    document.getElementById('submit-btn').textContent = 'Aggiungi Movimento'; 
                } else { 
                    giornaleAperto.movimenti.push(formData); 
                } 
                
                // 2. Salva l'intero array 'movimenti' aggiornato su Firestore
                try {
                    await giornaliCollection.doc(giornaleAperto.firestoreId).update({
                        movimenti: giornaleAperto.movimenti
                    });
                    
                    // 3. Ricarica la vista e resetta il form
                    this.render(); 
                    e.target.reset();
                } catch (error) {
                    console.error("Errore salvataggio movimento: ", error);
                    alert("Errore durante il salvataggio del movimento.");
                }
            }
            
            // FUNZIONI RIMOSSE: backupDati(), ripristinaDati()
        };

        app.init();
    });
    </script>
</body>
</html>
