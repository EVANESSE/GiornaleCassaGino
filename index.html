<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giornale Cassa Allianz (Firebase)</title>
    <style>
        :root {
            --colore-primario: #005f73; --colore-secondario: #0a9396; --colore-sfondo: #f8f9fa;
            --colore-container: #ffffff; --colore-testo: #212529; --colore-grigio: #6c757d;
            --colore-pericolo: #d90429; --colore-successo: #008000;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px; color: var(--colore-testo); background-color: var(--colore-sfondo);
        }
        .container {
            max-width: 1300px; margin: auto; background-color: var(--colore-container);
            padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center; font-size: 2.5em; padding: 15px; border-radius: 8px; color: white;
            background: linear-gradient(145deg, #495057, #212529); text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .section-title {
            color: var(--colore-primario); border-bottom: 2px solid var(--colore-secondario);
            padding-bottom: 10px; margin-top: 25px;
        }
        .controls, .backup-section, .main-actions {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            gap: 15px; padding: 15px; background: #e9ecef; border-radius: 8px; margin-bottom: 20px;
        }
        form {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;
            margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;
        }
        label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input, select { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em; }
        input:focus, select:focus { border-color: var(--colore-secondario); outline: none; box-shadow: 0 0 0 2px rgba(10, 147, 150, 0.25); }
        button, .button-like {
            padding: 10px 15px; border: none; border-radius: 5px; font-size: 1em; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover, .button-like:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; transform: none; box-shadow: none; }
        .primary-action { background-color: var(--colore-primario); color: white; }
        .secondary-action { background-color: var(--colore-grigio); color: white; }
        .danger-action { background-color: var(--colore-pericolo); color: white; }
        .success-action { background-color: var(--colore-successo); color: white; }
        .print-action { background-color: #0a9396; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: #343a40; color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .total-display { margin-top: 25px; text-align: right; font-size: 1.6em; font-weight: bold; color: var(--colore-primario); }
        .print-only { display: none; }
        
        .icon-btn {
            background: none; border: none; cursor: pointer; font-size: 1.2em;
            padding: 2px 5px; margin: 0 3px; border-radius: 4px; transition: background-color 0.2s;
        }
        .icon-btn:hover { background-color: #e9ecef; }
        
        /* Overlay per il caricamento */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2em; font-weight: bold; z-index: 1000;
            flex-direction: column; gap: 15px;
            color: var(--colore-primario);
        }
        
        @media print {
            @page { size: A4 portrait; margin: 2cm; }
            body { font-size: 10pt; color: #000; }
            body > *:not(.print-only) { display: none !important; }
            .print-only { display: block; }
            #print-header-content h1 { font-size: 18pt; margin-bottom: 5px; text-align: center; }
            #print-header-content h2 { font-size: 14pt; font-weight: bold; text-align: center; }
            #print-header-content p { font-size: 9pt; text-align: right; }
            #print-table-content table { width: 100%; font-size: 9pt; border-collapse: collapse; table-layout: fixed; }
            #print-table-content th, #print-table-content td { border: 1px solid #666; padding: 6px; word-wrap: break-word; text-align: left; }
            #print-table-content th { background-color: #e9ecef; }
            #print-total-content { text-align: right; font-size: 12pt; font-weight: bold; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <svg aria-hidden="true" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        <span>Caricamento e connessione a Firebase...</span>
    </div>

    <div class="print-only">
        <div id="print-header-content"></div>
        <div id="print-table-content"></div>
        <div id="print-total-content"></div>
    </div>

    <div class="container">
        <h1>Giornale Cassa Allianz (Firebase)</h1>
        
        <div class="controls">
            <div>
                <label for="giornali-salvati"><strong>Consulta un giornale chiuso:</strong></label>
                <select id="giornali-salvati"></select>
            </div>
            <div id="closed-journal-actions">
                <button id="stampa-btn" class="print-action">üñ®Ô∏è Stampa Giornale</button>
                <button id="riapri-giornale-btn" class="secondary-action">Riapri Giornale</button>
                <button id="elimina-giornale-btn" class="danger-action">Elimina Giornale</button>
            </div>
        </div>
        
        <div id="no-open-journal-view" class="main-actions">
            <span>Nessun giornale aperto. Selezionane uno da consultare o creane uno nuovo.</span>
            <button id="crea-nuovo-btn" class="success-action">Crea Nuovo Giornale</button>
        </div>

        <div id="main-view">
            <h2 class="section-title" id="titolo-giornale"></h2>
            <form id="movimento-form">
                <div class="form-group"><label for="ramo-polizza">Ramo Polizza</label><select id="ramo-polizza" required><option value="Auto">Auto</option><option value="Rami Vari">Rami Vari</option><option value="Vita">Vita</option></select></div>
                <div class="form-group"><label for="numero-polizza">N. Polizza</label><input type="text" id="numero-polizza" required></div>
                <div class="form-group"><label for="tipo-movimento">Tipo Movimento</label><select id="tipo-movimento" required><option value="Nuova Polizza">Nuova Polizza</option><option value="Quietanza">Quietanza</option><option value="Rimborso Premio">Rimborso Premio</option><option value="Regolazione Premio">Regolazione Premio</option><option value="Franchigia">Franchigia</option><option value="Sostituzione">Sostituzione</option><option value="Storno">Storno</option></select></div>
                <div class="form-group"><label for="modalita-pagamento">Modalit√† Pagamento</label><select id="modalita-pagamento" required><option value="Contanti">Contanti</option><option value="Assegno">Assegno</option><option value="Bonifico">Bonifico</option><option value="Allianz Bank">Allianz Bank</option><option value="POS Agenzia">POS Agenzia</option><option value="POS Direzione">POS Direzione</option></select></div>
                <div class="form-group"><label for="data-incasso">Data Incasso</label><input type="date" id="data-incasso" required></div>
                <div class="form-group"><label for="nome-cliente">Nome Cliente</label><input type="text" id="nome-cliente" required></div>
                <div class="form-group"><label for="importo">Importo Titolo (‚Ç¨)</label><input type="number" id="importo" step="0.01" min="0" required></div>
                <input type="hidden" id="editing-id">
                <button type="submit" id="submit-btn" class="primary-action" style="grid-column: 1 / -1;">Aggiungi Movimento</button>
            </form>
            <div class="main-actions" id="open-journal-actions">
                <button id="chiudi-giornale-btn" class="danger-action">Chiudi Giornale Cassa</button>
            </div>
            <table>
                <thead>
                    <tr><th>Ramo</th><th>N. Polizza</th><th>Movimento</th><th>Pagamento</th><th>Data Incasso</th><th>Cliente</th><th>Importo</th><th class="no-print">Azioni</th></tr>
                </thead>
                <tbody id="tabella-movimenti"></tbody>
            </table>
            <div class="total-display">Totale Cassa (Contanti e Assegni): ‚Ç¨ <span id="totale-cassa">0.00</span></div>
        </div>

        <!-- Sezione Backup nascosta, gestita da Firebase -->
        <h2 class="section-title" style="display: none;">Backup e Ripristino</h2>
        <div class="backup-section" style="display: none;">
            <button id="backup-btn" class="secondary-action">Backup / Esporta Dati</button>
            <div>
                 <label for="restore-input" class="button-like secondary-action">Importa Dati da Backup</label>
                 <input type="file" id="restore-input" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <!-- 
      IMPORTAZIONE DEI MODULI FIREBASE
      Questi script caricano le funzionalit√† di Firebase necessarie.
      Usiamo "type=module" per la sintassi moderna di importazione.
    -->
    <script type="module">
        // Importa le funzioni di Firebase necessarie
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAZIONE FIREBASE FORNITA DALL'UTENTE
        const firebaseConfig = {
          apiKey: "AIzaSyDqRAWYaoEQvpo9Eh0QfS351AdNuxse7kI",
          authDomain: "giornalecassagino.firebaseapp.com",
          projectId: "giornalecassagino",
          storageBucket: "giornalecassagino.firebasestorage.app",
          messagingSenderId: "792465698914",
          appId: "1:792465698914:web:57c4ae252e24abde5aa13b"
        };

        // Le variabili __app_id e __initial_auth_token 
        // vengono iniettate automaticamente dall'ambiente (se presenti).
        
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const app = {
                data: { giornali: [] },
                stato: {
                    giornaleApertoId: null,
                    giornaleVisualizzatoId: null,
                    idInModifica: null,
                    // Stato di Firebase
                    db: null,
                    auth: null,
                    userId: null,
                    isAuthReady: false,
                    collectionRef: null // Riferimento alla collezione Firestore
                },
                
                async init() {
                    // 1. Inizializza Firebase
                    await this.initFirebase();
                    // 2. Aggiungi gli event listener (pulsanti, form, ecc.)
                    this.addEventListeners();
                    // 3. setupDataListener() viene chiamato da initFirebase quando l'auth √® pronta
                    //    e onSnapshot() in setupDataListener chiamer√† render()
                },

                // --- NUOVA LOGICA FIREBASE ---
                
                /**
                 * Inizializza Firebase, gestisce l'autenticazione e imposta
                 * il listener per i dati non appena l'utente √® autenticato.
                 */
                async initFirebase() {
                    try {
                        // Carica la configurazione fornita dall'ambiente
                        // RIMOSSO: const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                        
                        // USA LA CONFIGURAZIONE DEFINITA SOPRA
                        const fbApp = initializeApp(firebaseConfig);
                        this.stato.db = getFirestore(fbApp);
                        this.stato.auth = getAuth(fbApp);
                        
                        // Abilita i log di debug di Firestore
                        setLogLevel('Debug');

                        // Ascolta i cambiamenti dello stato di autenticazione
                        onAuthStateChanged(this.stato.auth, async (user) => {
                            if (user) {
                                // Utente gi√† autenticato (o appena autenticato)
                                this.stato.userId = user.uid;
                                this.stato.isAuthReady = true;
                                console.log("Utente autenticato (ID):", this.stato.userId);
                                
                                // Ora che abbiamo un utente, impostiamo il listener
                                this.setupDataListener(); 
                            } else {
                                // Nessun utente, esegui l'accesso
                                console.log("Nessun utente, avvio accesso...");
                                try {
                                    // Prova prima con il token personalizzato (se fornito)
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                        await signInWithCustomToken(this.stato.auth, __initial_auth_token);
                                    } else {
                                        // Altrimenti, usa l'accesso anonimo
                                        await signInAnonymously(this.stato.auth);
                                    }
                                    // onAuthStateChanged verr√† chiamato di nuovo dopo l'accesso
                                } catch (authError) {
                                    console.error("Errore durante l'accesso:", authError);
                                    loadingOverlay.textContent = "Errore di autenticazione. Ricarica la pagina.";
                                }
                            }
                        });

                    } catch (e) {
                        console.error("Errore fatale nell'inizializzazione di Firebase:", e);
                        loadingOverlay.textContent = "Impossibile caricare Firebase. Ricarica la pagina.";
                    }
                },

                /**
                 * Imposta il listener onSnapshot di Firestore.
                 * Questa funzione sostituisce il vecchio loadData().
                 * Viene chiamata solo DOPO che l'autenticazione √® riuscita.
                 */
                setupDataListener() {
                    if (!this.stato.isAuthReady || !this.stato.userId) {
                        console.error("Autenticazione non pronta, impossibile impostare il listener.");
                        return;
                    }
                    
                    // Costruisci il percorso sicuro e privato per i dati dell'utente
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const collectionPath = \`/artifacts/${appId}/users/${this.stato.userId}/giornali\`;
                    
                    this.stato.collectionRef = collection(this.stato.db, collectionPath);
                    console.log("Ascolto la collezione:", collectionPath);
                    
                    const q = query(this.stato.collectionRef);
                    
                    // onSnapshot ascolta le modifiche in tempo reale
                    onSnapshot(q, (querySnapshot) => {
                        console.log("Dati ricevuti da Firestore.");
                        // Converte i documenti in un array di dati, aggiungendo l'ID
                        this.data.giornali = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Aggiorna lo stato per il giornale aperto
                        const giornaleAperto = this.data.giornali.find(g => g.stato === 'aperto');
                        if (giornaleAperto) {
                            this.stato.giornaleApertoId = giornaleAperto.id;
                            if (!this.stato.giornaleVisualizzatoId || this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId)?.stato !== 'aperto') {
                                this.stato.giornaleVisualizzatoId = giornaleAperto.id;
                            }
                        } else {
                            this.stato.giornaleApertoId = null;
                        }
                        
                        // Se il giornale che stavamo guardando √® stato eliminato, resetta la vista
                        if (this.stato.giornaleVisualizzatoId && !this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId)) {
                             this.stato.giornaleVisualizzatoId = this.stato.giornaleApertoId; // Torna a quello aperto o null
                        }

                        // Chiama render() per aggiornare l'interfaccia con i nuovi dati
                        this.render(); 
                        
                        // Nasconde l'overlay di caricamento
                        loadingOverlay.style.display = 'none';
                    }, (error) => {
                        console.error("Errore durante l'ascolto di Firestore:", error);
                        loadingOverlay.textContent = "Errore di connessione al database.";
                    });
                },

                // --- FUNZIONI DI RENDER (INVARIATE) ---
                render() { const giornaleVisualizzato = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); this.renderUI(giornaleVisualizzato); this.renderDropdown(); this.renderTabella(giornaleVisualizzato); this.renderTotale(giornaleVisualizzato); },
                renderUI(giornale) { const mainView = document.getElementById('main-view'), noOpenJournalView = document.getElementById('no-open-journal-view'), form = document.getElementById('movimento-form'), openJournalActions = document.getElementById('open-journal-actions'), closedJournalActions = document.getElementById('closed-journal-actions'), titoloGiornale = document.getElementById('titolo-giornale'); mainView.style.display = 'none'; noOpenJournalView.style.display = 'none'; form.style.display = 'none'; openJournalActions.style.display = 'none'; closedJournalActions.style.display = 'none'; if (!this.stato.giornaleApertoId && !giornale) { noOpenJournalView.style.display = 'flex'; } else { mainView.style.display = 'block'; if (giornale && giornale.stato === 'aperto') { titoloGiornale.textContent = 'Giornale Cassa Attuale (Aperto)'; form.style.display = 'grid'; openJournalActions.style.display = 'flex'; } else if (giornale) { titoloGiornale.textContent = `Riepilogo Giornale N. ${giornale.numero || 'N/A'}/${giornale.anno || 'N/A'} (Chiuso il ${giornale.dataChiusura})`; closedJournalActions.style.display = 'flex'; } } },
                renderDropdown() { const select = document.getElementById('giornali-salvati'); select.innerHTML = '<option value="">Seleziona per consultare...</option>'; this.data.giornali.filter(g => g.stato === 'chiuso').sort((a, b) => (b.anno - a.anno) || (b.numero - a.numero)).forEach(g => { const option = document.createElement('option'); option.value = g.id; option.textContent = `N. ${g.numero || 'N/A'}/${g.anno || 'N/A'} - Chiuso il ${g.dataChiusura}`; select.appendChild(option); }); select.value = (this.stato.giornaleVisualizzatoId !== this.stato.giornaleApertoId) ? this.stato.giornaleVisualizzatoId : ""; },
                renderTabella(giornale) {
                    const tbody = document.getElementById('tabella-movimenti');
                    tbody.innerHTML = '';
                    if (!giornale) return;
                    // Ordina i movimenti per ID (data di creazione)
                    const movimentiOrdinati = giornale.movimenti.sort((a, b) => a.id - b.id);
                    movimentiOrdinati.forEach(m => {
                        const row = tbody.insertRow();
                        const actionsHTML = giornale.stato === 'aperto'
                            ? `<button class="icon-btn edit-btn" title="Modifica movimento" data-id="${m.id}">‚úèÔ∏è</button>
                               <button class="icon-btn delete-btn" title="Elimina movimento" data-id="${m.id}">‚ùå</button>`
                            : '‚Äî';
                        
                        row.innerHTML = `<td>${m.ramo}</td><td>${m.numeroPolizza}</td><td>${m.tipo}</td><td>${m.pagamento}</td><td>${new Date(m.data).toLocaleDateString('it-IT')}</td><td>${m.cliente}</td><td>${m.importo.toFixed(2).replace('.',',')} ‚Ç¨</td><td class="no-print">${actionsHTML}</td>`;
                    });
                },
                renderTotale(giornale) { const totaleEl = document.getElementById('totale-cassa'); if (!giornale) { totaleEl.textContent = '0.00'; return; } const totale = giornale.movimenti.filter(m => m.pagamento === 'Contanti' || m.pagamento === 'Assegno').reduce((sum, m) => sum + m.importo, 0); totaleEl.textContent = totale.toFixed(2).replace('.', ','); },
                
                // --- EVENT LISTENER (Backup rimosso) ---
                addEventListeners() { 
                    document.getElementById('crea-nuovo-btn').addEventListener('click', () => this.creaNuovoGiornale()); 
                    document.getElementById('movimento-form').addEventListener('submit', (e) => this.gestisciSubmit(e)); 
                    document.getElementById('tabella-movimenti').addEventListener('click', (e) => this.gestisciClickTabella(e)); 
                    document.getElementById('chiudi-giornale-btn').addEventListener('click', () => this.chiudiGiornale()); 
                    document.getElementById('giornali-salvati').addEventListener('change', (e) => this.visualizzaGiornaleSalvato(e)); 
                    document.getElementById('riapri-giornale-btn').addEventListener('click', () => this.riapriGiornale()); 
                    document.getElementById('elimina-giornale-btn').addEventListener('click', () => this.eliminaGiornale()); 
                    document.getElementById('stampa-btn').addEventListener('click', () => this.stampaGiornale()); 
                    // Event listener per backup e ripristino rimossi
                },

                // --- AZIONI SUI MOVIMENTI (ora `async` e usano `updateDoc`) ---
                async eliminaMovimento(movimentoId) {
                    if (!confirm('Sei sicuro di voler eliminare questo movimento?')) return;
                    const giornaleAperto = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                    if (!giornaleAperto) return;
                    
                    // Filtra l'array e crea un nuovo array
                    const nuoviMovimenti = giornaleAperto.movimenti.filter(m => m.id !== movimentoId);
                    
                    // Prepara il riferimento al documento
                    const docRef = doc(this.stato.db, this.stato.collectionRef.path, giornaleAperto.id);
                    
                    try {
                        // Aggiorna solo il campo 'movimenti' in Firestore
                        await updateDoc(docRef, { movimenti: nuoviMovimenti });
                        // onSnapshot() si occuper√† di chiamare render()
                    } catch (e) {
                        console.error("Errore nell'eliminazione del movimento: ", e);
                        // Mostra un errore all'utente (non con alert)
                    }
                },

                gestisciClickTabella(e) {
                    const target = e.target.closest('.icon-btn');
                    if (!target) return;

                    const id = parseInt(target.dataset.id);
                    if (target.classList.contains('edit-btn')) {
                        const giornaleAperto = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                        const movimento = giornaleAperto.movimenti.find(m => m.id === id);
                        if(movimento) {
                            document.getElementById('ramo-polizza').value = movimento.ramo; 
                            document.getElementById('numero-polizza').value = movimento.numeroPolizza; 
                            document.getElementById('tipo-movimento').value = movimento.tipo; 
                            document.getElementById('modalita-pagamento').value = movimento.pagamento; 
                            document.getElementById('data-incasso').value = movimento.data; 
                            document.getElementById('nome-cliente').value = movimento.cliente; 
                            document.getElementById('importo').value = movimento.importo;
                            this.stato.idInModifica = id;
                            document.getElementById('submit-btn').textContent = 'Salva Modifiche';
                            window.scrollTo(0, 0);
                        }
                    } else if (target.classList.contains('delete-btn')) {
                        this.eliminaMovimento(id); // Questa ora √® async
                    }
                },
                
                async gestisciSubmit(e) {
                    e.preventDefault();
                    const giornaleAperto = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                    if (!giornaleAperto) return;

                    const formData = { 
                        id: this.stato.idInModifica || Date.now(), // Usa un timestamp come ID univoco
                        ramo: document.getElementById('ramo-polizza').value, 
                        numeroPolizza: document.getElementById('numero-polizza').value, 
                        tipo: document.getElementById('tipo-movimento').value, 
                        pagamento: document.getElementById('modalita-pagamento').value, 
                        data: document.getElementById('data-incasso').value, 
                        cliente: document.getElementById('nome-cliente').value, 
                        importo: parseFloat(document.getElementById('importo').value) 
                    };

                    let nuoviMovimenti;
                    if (this.stato.idInModifica) {
                        // Aggiorna movimento esistente
                        nuoviMovimenti = giornaleAperto.movimenti.map(m => m.id === this.stato.idInModifica ? formData : m);
                    } else {
                        // Aggiungi nuovo movimento
                        nuoviMovimenti = [...giornaleAperto.movimenti, formData];
                    }

                    const docRef = doc(this.stato.db, this.stato.collectionRef.path, giornaleAperto.id);
                    try {
                        await updateDoc(docRef, { movimenti: nuoviMovimenti });
                        // Resetta il form solo dopo il successo
                        this.stato.idInModifica = null;
                        document.getElementById('submit-btn').textContent = 'Aggiungi Movimento';
                        e.target.reset();
                        // onSnapshot() si occuper√† di chiamare render()
                    } catch (e) {
                        console.error("Errore nell'aggiornamento dei movimenti: ", e);
                    }
                },
                
                // --- AZIONI SUI GIORNALI (ora `async` e usano `addDoc`, `updateDoc`, `deleteDoc`) ---
                
                stampaGiornale() { const giornale = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); if (!giornale) { alert("Per favore, seleziona un giornale da stampare."); return; } const headerContainer = document.getElementById('print-header-content'); const oggi = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }); let headerHTML = `<h1>Giornale Cassa Allianz Gino</h1>`; if (giornale.stato === 'chiuso') { headerHTML += `<h2>Giornale N. ${giornale.numero || 'N/A'}/${giornale.anno || 'N/A'} - Chiuso il ${giornale.dataChiusura}</h2>`; } else { headerHTML += `<h2>Giornale Attuale (Aperto - non ancora numerato)</h2>`; } headerHTML += `<p>Stampato il: ${oggi}</p>`; headerContainer.innerHTML = headerHTML; const tableContainer = document.getElementById('print-table-content'); let tableHTML = `<table><thead><tr><th style="width:10%">Ramo</th><th style="width:13%">N. Polizza</th><th style="width:17%">Movimento</th><th style="width:13%">Pagamento</th><th style="width:12%">Data Incasso</th><th style="width:23%">Cliente</th><th style="width:12%">Importo</th></tr></thead><tbody>`; giornale.movimenti.forEach(m => { tableHTML += `<tr><td>${m.ramo}</td><td>${m.numeroPolizza}</td><td>${m.tipo}</td><td>${m.pagamento}</td><td>${new Date(m.data).toLocaleDateString('it-IT')}</td><td>${m.cliente}</td><td>${m.importo.toFixed(2).replace('.',',')} ‚Ç¨</td></tr>`; }); tableHTML += `</tbody></table>`; tableContainer.innerHTML = tableHTML; const totalContainer = document.getElementById('print-total-content'); const totale = giornale.movimenti.filter(m => m.pagamento === 'Contanti' || m.pagamento === 'Assegno').reduce((sum, m) => sum + m.importo, 0); totalContainer.innerHTML = `Totale Cassa (Contanti e Assegni): ‚Ç¨ ${totale.toFixed(2).replace('.', ',')}`; window.print(); },
                
                async creaNuovoGiornale() { 
                    if(this.stato.giornaleApertoId) { alert("Puoi creare un nuovo giornale solo dopo aver chiuso quello attuale."); return; } 
                    const nuovoGiornale = { 
                        // l'ID di Firebase viene usato come ID, non pi√π Date.now()
                        numero: null, 
                        anno: null, 
                        dataChiusura: null, 
                        stato: 'aperto', 
                        movimenti: [],
                        dataCreazione: new Date().toISOString() // Utile per ordinare
                    }; 
                    try {
                        // Aggiunge il documento a Firestore
                        const docRef = await addDoc(this.stato.collectionRef, nuovoGiornale);
                        // Imposta la vista sul nuovo giornale creato
                        this.stato.giornaleVisualizzatoId = docRef.id;
                        // onSnapshot() si occuper√† di aggiornare i dati e chiamare render()
                    } catch (e) {
                        console.error("Errore nella creazione del giornale: ", e);
                    }
                },
                
                async chiudiGiornale() { 
                    if (!confirm('Sei sicuro di voler chiudere il giornale cassa attuale?')) return; 
                    
                    const giornaleDaChiudere = this.data.giornali.find(g => g.id === this.stato.giornaleApertoId);
                    if (!giornaleDaChiudere) return;
                    
                    const annoCorrente = new Date().getFullYear().toString();
                    const giornaliDellAnno = this.data.giornali.filter(g => g.anno === annoCorrente && g.stato === 'chiuso');
                    const maxNumero = giornaliDellAnno.reduce((max, g) => Math.max(max, g.numero || 0), 0);
                    
                    const datiAggiornati = {
                        stato: 'chiuso', 
                        dataChiusura: new Date().toLocaleDateString('it-IT'), 
                        numero: maxNumero + 1,
                        anno: annoCorrente
                    };
                    
                    const docRef = doc(this.stato.db, this.stato.collectionRef.path, giornaleDaChiudere.id);
                    try {
                        await updateDoc(docRef, datiAggiornati);
                        // Aggiorna lo stato locale per la navigazione
                        this.stato.giornaleApertoId = null; 
                        this.stato.giornaleVisualizzatoId = giornaleDaChiudere.id;
                        // onSnapshot() si occuper√† di chiamare render()
                    } catch (e) {
                        console.error("Errore nella chiusura del giornale: ", e);
                    }
                },

                async riapriGiornale() { 
                    if (this.stato.giornaleApertoId) { alert("Chiudi prima il giornale corrente per poter riaprire questo."); return; } 
                    const giornaleDaRiaprire = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); 
                    if (!giornaleDaRiaprire || giornaleDaRiaprire.stato !== 'chiuso') { alert("Seleziona un giornale chiuso da riaprire."); return; } 
                    if (!confirm('Sei sicuro di voler riaprire questo giornale?')) return; 

                    const datiAggiornati = {
                        stato: 'aperto', 
                        numero: null,
                        anno: null,
                        dataChiusura: null
                    };

                    const docRef = doc(this.stato.db, this.stato.collectionRef.path, giornaleDaRiaprire.id);
                    try {
                        await updateDoc(docRef, datiAggiornati);
                        // onSnapshot() si occuper√† di aggiornare lo stato e chiamare render()
                    } catch (e) {
                        console.error("Errore nella riapertura del giornale: ", e);
                    }
                },
                
                async eliminaGiornale() { 
                    const giornaleDaEliminare = this.data.giornali.find(g => g.id === this.stato.giornaleVisualizzatoId); 
                    if (!giornaleDaEliminare || giornaleDaEliminare.stato !== 'chiuso') { alert("Puoi eliminare solo un giornale chiuso."); return; } 
                    if (!confirm(`Sei sicuro di voler eliminare definitivamente il "Giornale Cassa N. ${giornaleDaEliminare.numero || 'N/A'}/${giornaleDaEliminare.anno || 'N/A'}"? L'azione √® irreversibile.`)) return; 
                    
                    const docRef = doc(this.stato.db, this.stato.collectionRef.path, giornaleDaEliminare.id);
                    try {
                        await deleteDoc(docRef);
                        // Resetta la vista
                        this.stato.giornaleVisualizzatoId = null;
                        // onSnapshot() si occuper√† di aggiornare i dati e chiamare render()
                    } catch (e) {
                        console.error("Errore nell'eliminazione del giornale: ", e);
                    }
                },
                
                visualizzaGiornaleSalvato(e) { 
                    const id = e.target.value; // L'ID di Firestore √® una stringa
                    this.stato.giornaleVisualizzatoId = id || this.stato.giornaleApertoId || null; 
                    this.render(); // Chiama render() direttamente per cambiare la vista
                }
            };

            // Avvia l'applicazione
            app.init();
        });
    </script>
</body>
</html>
